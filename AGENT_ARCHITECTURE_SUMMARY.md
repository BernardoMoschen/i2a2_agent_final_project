# ๐ฏ RESUMO: Como o Agente se Comunica com as Ferramentas

## ๐ Arquitetura Simplificada

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         USUรRIO                                  โ
โ                 "Quantas notas de compra temos?"                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    AGENT CORE                                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ 1. Recebe pergunta do usuรกrio                          โ    โ
โ  โ 2. Adiciona ao histรณrico (memรณria)                     โ    โ
โ  โ 3. Envia para LLM (Gemini) com:                        โ    โ
โ  โ    โข System Prompt (instruรงรตes)                        โ    โ
โ  โ    โข Histรณrico da conversa                             โ    โ
โ  โ    โข Lista de ferramentas disponรญveis                  โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   LLM (Google Gemini)                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ Raciocรญnio (ReAct Pattern):                            โ    โ
โ  โ                                                         โ    โ
โ  โ Thought: "Usuรกrio quer CONTAR notas de COMPRA.        โ    โ
โ  โ           Preciso usar search_invoices_database"       โ    โ
โ  โ                                                         โ    โ
โ  โ Interpreta termos:                                      โ    โ
โ  โ   โข "quantas" โ preciso contar, use days_back=9999     โ    โ
โ  โ   โข "compra" โ operation_type='purchase'               โ    โ
โ  โ                                                         โ    โ
โ  โ Action: search_invoices_database                        โ    โ
โ  โ Action Input: {                                         โ    โ
โ  โ   "operation_type": "purchase",                        โ    โ
โ  โ   "days_back": 9999                                     โ    โ
โ  โ }                                                       โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               LANGCHAIN EXECUTOR                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ 1. Valida a ferramenta existe                          โ    โ
โ  โ 2. Valida os parรขmetros (Pydantic)                     โ    โ
โ  โ 3. Executa DatabaseSearchTool._run()                   โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              FERRAMENTA: DatabaseSearchTool                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ def _run(operation_type='purchase', days_back=9999):   โ    โ
โ  โ                                                         โ    โ
โ  โ   # ๐จ HARDCODED: Forรงa days_back=9999 se tem op_type โ    โ
โ  โ   if operation_type is not None:                       โ    โ
โ  โ       days_back = 9999  # Garantia!                    โ    โ
โ  โ                                                         โ    โ
โ  โ   # Consulta banco de dados                            โ    โ
โ  โ   db = DatabaseManager()                               โ    โ
โ  โ   invoices = db.search_invoices(                       โ    โ
โ  โ       operation_type='purchase',                       โ    โ
โ  โ       days_back=9999                                    โ    โ
โ  โ   )                                                     โ    โ
โ  โ                                                         โ    โ
โ  โ   # Formata resultado                                   โ    โ
โ  โ   return """                                            โ    โ
โ  โ   ๐ Encontrados 2 documento(s):                       โ    โ
โ  โ   - ๐ฅ Compras: 2                                      โ    โ
โ  โ   [detalhes...]                                         โ    โ
โ  โ   """                                                   โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                DATABASE (SQLite)                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ SELECT * FROM invoices                                  โ    โ
โ  โ WHERE operation_type = 'purchase'                       โ    โ
โ  โ   AND issue_date >= (TODAY - 9999 days)                โ    โ
โ  โ                                                         โ    โ
โ  โ Retorna: 2 documentos                                   โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              RESULTADO volta para LLM                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ Observation: "๐ Encontrados 2 documento(s)..."        โ    โ
โ  โ                                                         โ    โ
โ  โ LLM processa:                                           โ    โ
โ  โ   Thought: "Agora tenho a informaรงรฃo completa"         โ    โ
โ  โ   Final Answer: [Resposta formatada para usuรกrio]      โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    RESPOSTA AO USUรRIO                           โ
โ                                                                  โ
โ  ๐ Temos 2 notas de compra no sistema!                         โ
โ                                                                  โ
โ  ๐ฐ Valor total: R$ 1,522.50                                    โ
โ                                                                  โ
โ  ๐ฅ Documentos encontrados:                                      โ
โ  1. NFe 3510129/1 - COMPANHIA BRASILEIRA... - R$ 522.50        โ
โ  2. NFe 1/1 - FORNECEDOR TESTE LTDA - R$ 1,000.00              โ
โ                                                                  โ
โ  โจ Posso mostrar mais detalhes de alguma nota especรญfica?      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Componentes Principais

### 1๏ธโฃ **Agent Core** (`src/agent/agent_core.py`)
- Orquestrador principal
- Gerencia memรณria (histรณrico)
- Conecta LLM com ferramentas

### 2๏ธโฃ **System Prompt** (`src/agent/prompts.py`)
- **Instruรงรตes** para o LLM
- **Mapeamentos** de termos leigos โ tรฉcnicos
- **Regras crรญticas** de uso das ferramentas
- **Exemplos** de interpretaรงรฃo correta

### 3๏ธโฃ **Ferramentas** (`src/agent/tools.py`)
- `DatabaseSearchTool` โญ PRINCIPAL
- `DatabaseStatsTool`
- `ParseXMLTool`
- `ValidateInvoiceTool`
- `FiscalKnowledgeTool`

### 4๏ธโฃ **Database Manager** (`src/database/db.py`)
- Acessa SQLite
- Filtra documentos
- Retorna resultados

## ๐ฏ Melhorias Implementadas

### โ System Prompt Melhorado

**ANTES:**
```python
"Use search_invoices_database to search documents"
```

**DEPOIS:**
```python
"""
๐ฏ MISSรO: Interpretar perguntas em LINGUAGEM SIMPLES

MAPEAMENTO DE TERMOS:
- "compra", "comprei" โ operation_type='purchase'
- "quantas", "total" โ days_back=9999 (SEMPRE!)
- "2024", "este ano" โ days_back=9999

REGRAS CRรTICAS:
1. SEMPRE que usuรกrio perguntar "quantas" โ days_back=9999
2. SEMPRE que mencionar ano โ days_back=9999
3. NUNCA diga "nรฃo encontrei" sem tentar days_back=9999

EXEMPLOS:
"Quantas compras?" โ operation_type='purchase', days_back=9999
"Vendas de 2024" โ operation_type='sale', days_back=9999
"""
```

### โ Hardcoded Enforcement

**Garantia no cรณdigo** (nรฃo depende de LLM seguir instruรงรตes):

```python
def _run(self, operation_type=None, days_back=3650):
    # ๐จ CRITICAL: Force days_back=9999 when filtering by operation_type
    if operation_type is not None:
        days_back = 9999  # โ AUTOMรTICO!
        logger.info("๐ง Auto-forcing days_back=9999")
    
    # Continue com a busca...
```

### โ Documentaรงรฃo para Usuรกrios

Criados 3 guias:
1. **AGENT_COMMUNICATION.md** - Como funciona tecnicamente
2. **USER_QUESTIONS_GUIDE.md** - Perguntas comuns para usuรกrios
3. **FISCAL_VALIDATIONS.md** - Validaรงรตes implementadas

## ๐ Mapeamentos Implementados

### Termos Leigos โ Tรฉcnicos

| Usuรกrio Diz | Sistema Entende |
|-------------|-----------------|
| "compra", "comprei", "entrada" | `operation_type='purchase'` |
| "venda", "vendi", "saรญda" | `operation_type='sale'` |
| "quantas", "total", "tudo" | `days_back=9999` |
| "2024", "este ano" | `days_back=9999` |
| "nota fiscal", "nf" | `document_type='NFe'` |
| "cupom" | `document_type='NFCe'` |
| "semana" | `days_back=14` |
| "mรชs passado" | `days_back=60` |
| "hoje" | `days_back=1` |

## ๐ Exemplos de Uso

### Pergunta Simples โ Resposta Precisa

```
๐ค "Quantas notas de compra temos?"

๐ค Pensa:
   - "quantas" = contar = days_back=9999
   - "compra" = operation_type='purchase'
   
๐ค Executa:
   search_invoices_database(operation_type='purchase', days_back=9999)
   
๐ค Responde:
   "๐ Temos 2 notas de compra! ๐ฐ R$ 1,522.50"
```

### Seguindo Instruรงรตes Claramente

```
๐ค "Compras de 2024"

๐ค Pensa:
   - "2024" = ano especรญfico = days_back=9999
   - "compras" = operation_type='purchase'
   
๐ค Executa:
   search_invoices_database(operation_type='purchase', days_back=9999)
   
๐ค Responde:
   "๐ Encontrei 2 compras em 2024..."
```

## ๐ Aprendizados Importantes

### 1. **Trรชs Camadas de Proteรงรฃo**

1. **Default Value** (3650 dias = 10 anos fiscal)
2. **LLM Instructions** (prompts claros e exemplos)
3. **Hardcoded Enforcement** โญ (garantia no cรณdigo)

### 2. **Nรฃo Confie Apenas no LLM**

Mesmo com instruรงรตes perfeitas, o LLM pode:
- Interpretar errado
- Escolher parรขmetros inadequados
- Ignorar regras

**Soluรงรฃo:** Hardcode validaรงรตes crรญticas no cรณdigo da ferramenta!

### 3. **Simplicidade para o Usuรกrio**

Usuรกrio nรฃo deve saber:
- Nomes de ferramentas
- Parรขmetros tรฉcnicos
- Estrutura de dados

Basta fazer perguntas naturais! ๐ฃ๏ธ

## ๐ Documentos Criados

1. โ `docs/AGENT_COMMUNICATION.md` - Arquitetura tรฉcnica completa
2. โ `docs/USER_QUESTIONS_GUIDE.md` - Guia para usuรกrios comuns
3. โ `docs/FISCAL_VALIDATIONS.md` - Validaรงรตes implementadas
4. โ `src/agent/prompts.py` - System prompt melhorado
5. โ `src/agent/tools.py` - Hardcoded enforcement

## ๐ฏ Resultado Final

**ANTES:**
```
๐ค "Quantas compras temos?"
๐ค "โ Nรฃo encontrei nenhuma compra."
```

**DEPOIS:**
```
๐ค "Quantas compras temos?"
๐ค "๐ Temos 2 notas de compra!
    ๐ฐ R$ 1,522.50
    [Lista completa com detalhes...]"
```

## โจ Prรณximos Passos

Sistema estรก **pronto para produรงรฃo**! ๐

Usuรกrios podem:
- โ Fazer perguntas em **linguagem natural**
- โ Obter **respostas precisas**
- โ Nรฃo precisar conhecer **termos tรฉcnicos**
- โ Explorar o sistema **intuitivamente**

---

**Sistema:** LLM Fiscal XML Agent
**Stack:** LangChain + Gemini + Streamlit + SQLite
**Padrรฃo:** ReAct (Reasoning + Acting)
**Status:** โ Pronto para Produรงรฃo
